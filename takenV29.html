<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taken Versie 29 - Chiro Leopoldsburg</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body { background-color: #f9fafb; }
nav { background-color: #c62828; }
.container { margin-top: 30px; }
.card { margin-bottom: 20px; position: relative; border-left: 5px solid transparent; }
.card-content { padding-bottom: 1rem; }
.filter-container { margin-bottom: 20px; }

/* Status tekstkleuren */
.status-ok { color: green; font-weight: bold; }
.status-bezig { color: orange; font-weight: bold; }
.status-nok { color: red; font-weight: bold; }

/* Prioriteit kleuren */
.prioriteit-1 { background-color: #ffffff; }
.prioriteit-2 { background-color: #ffcdd2; }
.prioriteit-3 { background-color: #ef9a9a; }
.prioriteit-4 { background-color: #e57373; }
.prioriteit-5 { background-color: #d32f2f; color: white; }
.prioriteit-label { padding: 3px 6px; border-radius: 4px; display: inline-block; }

/* Gemarkeerd */
.card-markeren { border-left: 5px solid orange; }

/* Taak ID onderaan */
.taak-id { font-size: 0.8rem; color: #555; margin-top: 10px; text-align: right; }

/* Modal styling */
.modal { max-height: 80%; }
.modal-content h5 { margin-bottom: 15px; }
</style>
</head>
<body>

<nav>
  <div class="nav-wrapper">
    <a href="index.html" class="brand-logo center">Chiro Leopoldsburg</a>
  </div>
</nav>

<div class="container">
<h4 class="center-align">Taken Versie 29</h4>

<!-- Bovenliggende checkboxen -->
<div class="row filter-container">
  <div class="input-field col s12 m3">
    <label>
      <input type="checkbox" id="filterStatusOk">
      <span>Verberg taken met status "OK"</span>
    </label>
  </div>
  <div class="input-field col s12 m3">
    <label>
      <input type="checkbox" id="filterGemarkeerd">
      <span>Alleen gemarkeerde taken</span>
    </label>
  </div>
  <div class="col s12 m3">
    <a class="waves-effect waves-light btn modal-trigger" href="#filterModal">Filters instellen</a>
  </div>
</div>

<!-- Modal Structure -->
<div id="filterModal" class="modal">
  <div class="modal-content">
    <h5>Filters</h5>
    <div id="filterCheckboxes"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Sluiten</a>
  </div>
</div>

<div id="tasks-container" class="row"></div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const spreadsheetId = urlParams.get('spreadsheetId');
const tabblad = urlParams.get('tabblad');

const apiUrl = 'https://script.google.com/macros/s/AKfycbzxE1xtIxwT74WNMdfqYhhG4UGC8g2pUumgI2hK3CjW5RcVa3n5Q1UXNW64nHTHc6smig/exec';

let takenData = [];
const statusOptions = ["NOK", "Bezig", "OK"];
let selectedFilters = {verantwoordelijke:'', commissie:'', prioriteit:''};
let verbergOk = false;
let alleenGemarkeerd = false;

function getDeadlineText(deadlineObj) {
  const today = new Date(); today.setHours(0,0,0,0);
  const deadline = new Date(deadlineObj); deadline.setHours(0,0,0,0);
  const diffDays = Math.round((deadline - today) / (1000*60*60*24));
  if(diffDays < 0) return `Deadline is met ${Math.abs(diffDays)} dagen overschreden`;
  else if(diffDays === 0) return `Deadline is vandaag!`;
  else return `Deadline is over ${diffDays} dagen`;
}

async function fetchTaken() {
  try {
    const response = await fetch(`${apiUrl}?spreadsheetId=${spreadsheetId}&tabblad=${tabblad}`);
    const data = await response.json();

    data.forEach(t => {
      if(t.deadline) {
        const d = new Date(t.deadline);
        t.deadlineFormatted = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
        t.deadlineObj = d;
      }
    });

    data.forEach(t => {
      const index = takenData.findIndex(old => old.taakId === t.taakId);
      if(index !== -1) takenData[index] = t; 
      else takenData.push(t); 
    });

    vulFilters();
    renderTaken();
  } catch(err) {
    console.error("Fout bij ophalen taken:", err);
  }
}

function vulFilters() {
  const verantwoordelijken = [...new Set(takenData.map(t => t.verantwoordelijke).filter(Boolean))];
  const commissies = [...new Set(takenData.map(t => t.commissie).filter(Boolean))];
  const prioriteiten = [...new Set(takenData.map(t => t.prioriteit).filter(Boolean))].sort((a,b)=>a-b);

  const container = document.getElementById('filterCheckboxes');
  container.innerHTML = '';

  // Verantwoordelijke
  container.innerHTML += '<h6>Verantwoordelijke</h6>';
  verantwoordelijken.forEach(v => {
    const checked = selectedFilters.verantwoordelijke === v ? 'checked' : '';
    container.innerHTML += `<p><label><input name="verantwoordelijke" type="radio" value="${v}" ${checked}><span>${v}</span></label></p>`;
  });
  container.innerHTML += `<p><label><input name="verantwoordelijke" type="radio" value="" ${selectedFilters.verantwoordelijke === '' ? 'checked':''}><span>Alle</span></label></p>`;

  // Commissie
  container.innerHTML += '<h6>Commissie</h6>';
  commissies.forEach(c => {
    const checked = selectedFilters.commissie === c ? 'checked' : '';
    container.innerHTML += `<p><label><input name="commissie" type="radio" value="${c}" ${checked}><span>${c}</span></label></p>`;
  });
  container.innerHTML += `<p><label><input name="commissie" type="radio" value="" ${selectedFilters.commissie === '' ? 'checked':''}><span>Alle</span></label></p>`;

  // Prioriteit
  container.innerHTML += '<h6>Prioriteit</h6>';
  prioriteiten.forEach(p => {
    const checked = selectedFilters.prioriteit === String(p) ? 'checked' : '';
    container.innerHTML += `<p><label><input name="prioriteit" type="radio" value="${p}" ${checked}><span>${p}</span></label></p>`;
  });
  container.innerHTML += `<p><label><input name="prioriteit" type="radio" value="" ${selectedFilters.prioriteit === '' ? 'checked':''}><span>Alle</span></label></p>`;

  container.querySelectorAll('input[type=radio]').forEach(radio => {
    radio.addEventListener('change', () => {
      selectedFilters[radio.name] = radio.value;
      renderTaken();
    });
  });
}

function renderTaken() {
  const container = document.getElementById('tasks-container');
  container.innerHTML = '';

  const today = new Date();
  const filtered = takenData.filter(t => {
    if(verbergOk && t.status === 'OK') return false;
    if(alleenGemarkeerd && !t.markeren) return false;
    if(selectedFilters.verantwoordelijke && t.verantwoordelijke !== selectedFilters.verantwoordelijke) return false;
    if(selectedFilters.commissie && t.commissie !== selectedFilters.commissie) return false;
    if(selectedFilters.prioriteit && String(t.prioriteit) !== selectedFilters.prioriteit) return false;
    return true;
  });

  filtered.forEach(t => {
    const card = document.createElement('div');
    card.className = 'col s12';

    let cardClass = '';
    if(t.status==='OK') cardClass = 'green lighten-4';
    else if(t.deadlineObj && today >= t.deadlineObj) cardClass = 'red lighten-4';
    if(t.markeren) card.classList.add('card-markeren');

    card.innerHTML = `
      <div class="card ${cardClass}">
        <div class="card-content">
          <span class="card-title">${t.taakomschrijving}</span>
          <p><strong>Deadline:</strong> ${t.deadlineFormatted || '-'}<br>
          <span style="font-weight:bold;">${t.deadlineObj ? getDeadlineText(t.deadlineObj) : ''}</span></p>

          <p><strong>Prioriteit:</strong></p>
          ${[1,2,3,4,5].map(p => `<label><input type="radio" name="prioriteit-${t.taakId}" value="${p}" ${t.prioriteit==p?'checked':''}><span>${p}</span></label>`).join(' ')}

          <p><strong>Status:</strong></p>
          ${statusOptions.map(s => `<label><input type="radio" name="status-${t.taakId}" value="${s}" ${t.status===s?'checked':''}><span>${s}</span></label>`).join(' ')}

          <p>
            <label>
              <input type="checkbox" data-taakid="${t.taakId}" data-veld="markeren" ${t.markeren ? 'checked' : ''}/>
              <span>Markeren</span>
            </label>
          </p>

          <p>
            <label>
              <input type="checkbox" data-taakid="${t.taakId}" data-veld="verouderd" ${t.verouderd ? 'checked' : ''}/>
              <span>Verouderd</span>
            </label>
          </p>

          <p><strong>Verantwoordelijke:</strong>
            <input type="text" class="updateInput" data-taakid="${t.taakId}" data-veld="verantwoordelijke" value="${t.verantwoordelijke || ''}">
          </p>

          <p><strong>Commissie:</strong> ${t.commissie || '-'}</p>
          <p><strong>Bijlage:</strong> ${t.bijlage.includes('http') ? `<a href="${t.bijlage}" target="_blank">Bekijk bijlage</a>` : t.bijlage || 'Geen bijlage voor deze taak.'}</p>

          <p class="taak-id"><strong>Taak ID:</strong> ${t.taakId}</p>
        </div>
      </div>
    `;

    container.appendChild(card);
  });

  filtered.forEach(t => {
    document.querySelectorAll(`input[name=prioriteit-${t.taakId}]`).forEach(r => {
      r.addEventListener('change', e => updateVeld(t.taakId, 'prioriteit', e.target.value));
    });
    document.querySelectorAll(`input[name=status-${t.taakId}]`).forEach(r => {
      r.addEventListener('change', e => updateVeld(t.taakId, 'status', e.target.value));
    });
    const cbMarkeren = document.querySelector(`input[type=checkbox][data-taakid="${t.taakId}"][data-veld="markeren"]`);
    if(cbMarkeren) cbMarkeren.addEventListener('change', e => updateVeld(t.taakId, 'markeren', e.target.checked));
    const cbVerouderd = document.querySelector(`input[type=checkbox][data-taakid="${t.taakId}"][data-veld="verouderd"]`);
    if(cbVerouderd) cbVerouderd.addEventListener('change', e => updateVeld(t.taakId, 'verouderd', e.target.checked));
    const inp = document.querySelector(`input.updateInput[data-taakid="${t.taakId}"]`);
    if(inp) inp.addEventListener('change', e => updateVeld(t.taakId, 'verantwoordelijke', e.target.value));
  });
}

function updateVeld(taakId, veld, waarde) {
  fetch(apiUrl, {
    method: 'POST',
    body: JSON.stringify({ spreadsheetId, tabblad, taakId, veld, waarde })
  })
  .then(res => res.json())
  .then(res => { if(res.status!=='ok') console.error(res.message); })
  .catch(err => console.error(err));
}

document.addEventListener('DOMContentLoaded', function() {
  var elems = document.querySelectorAll('.modal');
  M.Modal.init(elems);

  // Bovenliggende checkboxes
  document.getElementById('filterStatusOk').addEventListener('change', e => { verbergOk = e.target.checked; renderTaken(); });
  document.getElementById('filterGemarkeerd').addEventListener('change', e => { alleenGemarkeerd = e.target.checked; renderTaken(); });
});

fetchTaken();
setInterval(fetchTaken, 15000);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
