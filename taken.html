<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taken Versie 12 - Chiro Leopoldsburg</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body { background-color: #f9fafb; }
nav { background-color: #c62828; }
.container { margin-top: 30px; }
.card { margin-bottom: 20px; }
.card-content { padding-bottom: 1rem; }
.status-ok { color: green; font-weight: bold; }
.status-bezig { color: orange; font-weight: bold; }
.status-nok { color: red; font-weight: bold; }
.taak-id { font-size: 0.8rem; color: #555; margin-top: 10px; text-align: right; }
</style>
</head>
<body>

<nav>
  <div class="nav-wrapper">
    <a href="index.html" class="brand-logo center">Chiro Leopoldsburg</a>
  </div>
</nav>

<div class="container">
<h4 class="center-align">Taken Versie 12</h4>

<div class="row filter-container">
  <div class="input-field col s12 m3">
    <select id="filterVerantwoordelijke"><option value="" selected>Alle verantwoordelijken</option></select>
    <label>Verantwoordelijke</label>
  </div>
  <div class="input-field col s12 m3">
    <select id="filterCommissie"><option value="" selected>Alle commissies</option></select>
    <label>Commissie</label>
  </div>
  <div class="input-field col s12 m3">
    <select id="filterPrioriteit"><option value="" selected>Alle prioriteiten</option></select>
    <label>Prioriteit</label>
  </div>
  <div class="input-field col s12 m3">
    <label>
      <input type="checkbox" id="filterStatusOk">
      <span>Verberg taken met status "OK"</span>
    </label>
  </div>
</div>

<div id="tasks-container" class="row"></div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const spreadsheetId = urlParams.get('spreadsheetId');
const tabblad = urlParams.get('tabblad');
const apiUrl = 'https://script.google.com/macros/s/AKfycbzxE1xtIxwT74WNMdfqYhhG4UGC8g2pUumgI2hK3CjW5RcVa3n5Q1UXNW64nHTHc6smig/exec';
const statusOptions = ["NOK","Bezig","OK"];
let takenData = [];

function formatDeadline(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr);
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}

async function fetchTaken(){
  try{
    const res = await fetch(`${apiUrl}?spreadsheetId=${spreadsheetId}&tabblad=${tabblad}`);
    const data = await res.json();
    data.forEach(t => { t.deadlineFormatted = formatDeadline(t.deadline); });
    takenData = data;
    renderFilters();
    renderTaken();
  }catch(err){ console.error(err); }
}

function renderFilters(){
  const selectVer = document.getElementById('filterVerantwoordelijke');
  const selectCom = document.getElementById('filterCommissie');
  const selectPrio = document.getElementById('filterPrioriteit');

  const verantwoordelijken = [...new Set(takenData.map(t=>t.verantwoordelijke).filter(Boolean))];
  const commissies = [...new Set(takenData.map(t=>t.commissie).filter(Boolean))];
  const prioriteiten = [...new Set(takenData.map(t=>t.prioriteit).filter(Boolean))].sort((a,b)=>a-b);

  verantwoordelijken.forEach(v=>{ if(!Array.from(selectVer.options).some(opt=>opt.value===v)) selectVer.appendChild(new Option(v,v)); });
  commissies.forEach(c=>{ if(!Array.from(selectCom.options).some(opt=>opt.value===c)) selectCom.appendChild(new Option(c,c)); });
  prioriteiten.forEach(p=>{ if(!Array.from(selectPrio.options).some(opt=>opt.value===p)) selectPrio.appendChild(new Option(p,p)); });

  M.FormSelect.init(selectVer);
  M.FormSelect.init(selectCom);
  M.FormSelect.init(selectPrio);

  ['filterVerantwoordelijke','filterCommissie','filterPrioriteit','filterStatusOk'].forEach(id=>{
    document.getElementById(id).addEventListener('change', renderTaken);
  });
}

function renderTaken(){
  const container = document.getElementById('tasks-container');
  container.innerHTML = '';

  const selectedVer = document.getElementById('filterVerantwoordelijke').value;
  const selectedCom = document.getElementById('filterCommissie').value;
  const selectedPrio = document.getElementById('filterPrioriteit').value;
  const verbergOk = document.getElementById('filterStatusOk').checked;

  const filtered = takenData.filter(t=>{
    if(selectedVer && t.verantwoordelijke!==selectedVer) return false;
    if(selectedCom && t.commissie!==selectedCom) return false;
    if(selectedPrio && t.prioriteit!==selectedPrio) return false;
    if(verbergOk && t.status==='OK') return false;
    return true;
  });

  const today = new Date();

  filtered.forEach(t=>{
    const deadlineDate = t.deadline?new Date(t.deadline):null;
    let cardClass='';
    if(t.status==='OK') cardClass='green lighten-4';
    else if(deadlineDate && today>=deadlineDate) cardClass='red lighten-4';

    container.insertAdjacentHTML('beforeend',`
      <div class="col s12">
        <div class="card ${cardClass}">
          <div class="card-content">
            <span class="card-title">${t.taakomschrijving}</span>
            <p><strong>Deadline:</strong> ${t.deadlineFormatted||'-'}</p>
            <p><strong>Prioriteit:</strong> ${t.prioriteit||'-'}</p>
            <p><strong>Verantwoordelijke:</strong> ${t.verantwoordelijke||'-'}</p>
            <p><strong>Status:</strong> ${t.status||'-'}</p>
            <p><strong>Commissie:</strong> ${t.commissie||'-'}</p>
            <p class="taak-id"><strong>Taak ID:</strong> ${t.taakId}</p>
          </div>
        </div>
      </div>
    `);
  });
}

fetchTaken();
setInterval(fetchTaken, 15000);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
