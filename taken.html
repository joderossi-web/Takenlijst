<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .task-card {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        transition: background-color 0.3s;
      }
      .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 16px;
      }
      .filter {
        padding: 4px;
        font-size: 14px;
      }
      label {
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <h2>ðŸ“‹ Takenoverzicht â€“ versie 19</h2>

    <div class="filters-container">
      <label class="filter">
        Prioriteit:
        <select id="filterPrioriteit" onchange="applyFilters()">
          <option value="">Alle</option>
          <option value="Laag">Laag</option>
          <option value="Normaal">Normaal</option>
          <option value="Hoog">Hoog</option>
        </select>
      </label>
      <label class="filter">
        Enkel gemarkeerd:
        <input type="checkbox" id="filterMarked" onchange="applyFilters()">
      </label>
    </div>

    <div id="takenContainer"></div>

    <script>
      let allTaken = [];
      let currentFilters = {};

      function renderTaken(taken) {
        const container = document.getElementById("takenContainer");
        const markedFilter = document.getElementById("filterMarked").checked;
        container.innerHTML = '';

        taken.forEach(taak => {
          if (markedFilter && !taak.Marked) return;
          const card = document.createElement("div");
          card.className = "task-card";
          card.dataset.taskId = taak.ID;

          card.style.backgroundColor = taak.Kleur || "#FFFFFF";

          card.innerHTML = `
            <strong>${taak.Taak}</strong><br>
            Prioriteit: 
            <select onchange="updateTaak(${taak.ID}, 'Prioriteit', this.value)">
              <option value="Laag" ${taak.Prioriteit === 'Laag' ? 'selected' : ''}>Laag</option>
              <option value="Normaal" ${taak.Prioriteit === 'Normaal' ? 'selected' : ''}>Normaal</option>
              <option value="Hoog" ${taak.Prioriteit === 'Hoog' ? 'selected' : ''}>Hoog</option>
            </select><br>
            
            Status: 
            <select onchange="updateTaak(${taak.ID}, 'Status', this.value)">
              <option value="Nieuw" ${taak.Status === 'Nieuw' ? 'selected' : ''}>Nieuw</option>
              <option value="In uitvoering" ${taak.Status === 'In uitvoering' ? 'selected' : ''}>In uitvoering</option>
              <option value="OK" ${taak.Status === 'OK' ? 'selected' : ''}>OK</option>
            </select><br>
            
            Markeren: 
            <input type="checkbox" ${taak.Marked ? 'checked' : ''} onclick="updateTaak(${taak.ID}, 'Marked', this.checked)">
          `;
          container.appendChild(card);
        });
      }

      function updateTaak(id, veld, waarde) {
        google.script.run.withSuccessHandler(updatedTaak => {
          const kaart = document.querySelector(`.task-card[data-task-id="${id}"]`);
          if (kaart && updatedTaak.Kleur) {
            kaart.style.backgroundColor = updatedTaak.Kleur;
          }
        }).updateTaak(id, veld, waarde);
      }

      function applyFilters() {
        currentFilters = {
          prioriteit: document.getElementById("filterPrioriteit").value,
          marked: document.getElementById("filterMarked").checked
        };
        renderTaken(applyFilterLogic(allTaken));
      }

      function applyFilterLogic(taken) {
        return taken.filter(taak => {
          if (currentFilters.prioriteit && taak.Prioriteit !== currentFilters.prioriteit) return false;
          if (currentFilters.marked && !taak.Marked) return false;
          return true;
        });
      }

      function periodicUpdate() {
        google.script.run.withSuccessHandler(data => {
          data.forEach(updatedTaak => {
            const index = allTaken.findIndex(t => t.ID === updatedTaak.ID);
            if (index > -1) allTaken[index] = updatedTaak;
          });
          renderTaken(applyFilterLogic(allTaken));
        }).getTaken();
      }

      google.script.run.withSuccessHandler(data => {
        allTaken = data;
        renderTaken(allTaken);
      }).getTaken();

      setInterval(periodicUpdate, 15000);
    </script>
  </body>
</html>
