<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taken Versie 26 - Chiro Leopoldsburg</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body { background-color: #f9fafb; }
nav { background-color: #c62828; }
.container { margin-top: 30px; }
.card { margin-bottom: 20px; position: relative; border-left: 5px solid transparent; }
.card-content { padding-bottom: 1rem; }
.filter-container { margin-bottom: 20px; }

/* Status tekstkleuren */
.status-ok { color: green; font-weight: bold; }
.status-bezig { color: orange; font-weight: bold; }
.status-nok { color: red; font-weight: bold; }

/* Prioriteit kleuren */
.prioriteit-1 { background-color: #ffffff; }
.prioriteit-2 { background-color: #ffcdd2; }
.prioriteit-3 { background-color: #ef9a9a; }
.prioriteit-4 { background-color: #e57373; }
.prioriteit-5 { background-color: #d32f2f; color: white; }

/* Gemarkeerd */
.card-markeren { border-left: 5px solid orange; }

/* Taak ID onderaan */
.taak-id { font-size: 0.8rem; color: #555; margin-top: 10px; text-align: right; }
</style>
</head>
<body>

<nav>
  <div class="nav-wrapper">
    <a href="index.html" class="brand-logo center">Chiro Leopoldsburg</a>
  </div>
</nav>

<div class="container">
<h4 class="center-align">Taken Versie 26</h4>

<div class="filter-container row">
  <div class="col s12 m3">
    <span>Verantwoordelijke:</span>
    <div id="filterVerantwoordelijkeContainer"></div>
  </div>
  <div class="col s12 m3">
    <span>Commissie:</span>
    <div id="filterCommissieContainer"></div>
  </div>
  <div class="col s12 m3">
    <span>Prioriteit:</span>
    <div id="filterPrioriteitContainer"></div>
  </div>
  <div class="col s12 m3">
    <p>
      <label>
        <input type="checkbox" id="filterStatusOk">
        <span>Verberg taken met status "OK"</span>
      </label>
    </p>
    <p>
      <label>
        <input type="checkbox" id="filterGemarkeerd">
        <span>Alleen gemarkeerde taken</span>
      </label>
    </p>
  </div>
</div>

<div id="tasks-container" class="row"></div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const spreadsheetId = urlParams.get('spreadsheetId');
const tabblad = urlParams.get('tabblad');

const apiUrl = 'https://script.google.com/macros/s/AKfycbzxE1xtIxwT74WNMdfqYhhG4UGC8g2pUumgI2hK3CjW5RcVa3n5Q1UXNW64nHTHc6smig/exec';

let takenData = [];

// Huidige filter keuze
const currentFilters = {
  verantwoordelijke: '',
  commissie: '',
  prioriteit: '',
  verbergOk: false,
  alleenGemarkeerd: false
};

// Huidige card keuzes
const currentCardChoices = {};

function getDeadlineText(deadlineObj) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const deadline = new Date(deadlineObj);
  deadline.setHours(0,0,0,0);
  const diffTime = deadline - today;
  const diffDays = Math.round(diffTime / (1000*60*60*24));
  if(diffDays<0) return `Deadline is met ${Math.abs(diffDays)} dagen overschreden`;
  else if(diffDays===0) return `Deadline is vandaag!`;
  else return `Deadline is over ${diffDays} dagen`;
}

async function fetchTaken() {
  try {
    const response = await fetch(`${apiUrl}?spreadsheetId=${spreadsheetId}&tabblad=${tabblad}`);
    const data = await response.json();

    data.forEach(t=>{
      if(t.deadline){
        const d = new Date(t.deadline);
        t.deadlineFormatted = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
        t.deadlineObj = d;
      }
    });

    data.forEach(t=>{
      const index = takenData.findIndex(old=>old.taakId===t.taakId);
      if(index!==-1) takenData[index]=t;
      else takenData.push(t);
    });

    vulFilterCheckboxes();
    renderTaken();
  } catch(err){
    console.error("Fout bij ophalen taken:", err);
  }
}

// Vul filters met checkboxen
function vulFilterCheckboxes(){
  const verContainer = document.getElementById('filterVerantwoordelijkeContainer');
  const verantwoordelijken = [...new Set(takenData.map(t=>t.verantwoordelijke).filter(Boolean))];
  verContainer.innerHTML='';
  verantwoordelijken.forEach(v=>{
    const p=document.createElement('p');
    p.innerHTML=`<label><input type="checkbox" name="verantwoordelijke" value="${v}" ${currentFilters.verantwoordelijke===v?'checked':''}/> <span>${v}</span></label>`;
    verContainer.appendChild(p);
  });

  const comContainer = document.getElementById('filterCommissieContainer');
  const commissies = [...new Set(takenData.map(t=>t.commissie).filter(Boolean))];
  comContainer.innerHTML='';
  commissies.forEach(c=>{
    const p=document.createElement('p');
    p.innerHTML=`<label><input type="checkbox" name="commissie" value="${c}" ${currentFilters.commissie===c?'checked':''}/> <span>${c}</span></label>`;
    comContainer.appendChild(p);
  });

  const prioContainer = document.getElementById('filterPrioriteitContainer');
  const prioriteiten = [...new Set(takenData.map(t=>t.prioriteit).filter(Boolean))].sort((a,b)=>a-b);
  prioContainer.innerHTML='';
  prioriteiten.forEach(p=>{
    const div=document.createElement('p');
    div.innerHTML=`<label><input type="checkbox" name="prioriteit" value="${p}" ${currentFilters.prioriteit==p?'checked':''}/> <span>${p}</span></label>`;
    prioContainer.appendChild(div);
  });

  // max 1 checkbox per filter type
  ['verantwoordelijke','commissie','prioriteit'].forEach(type=>{
    document.getElementsByName(type).forEach(cb=>{
      cb.addEventListener('change', e=>{
        if(e.target.checked) currentFilters[type]=e.target.value;
        else currentFilters[type]='';
        document.getElementsByName(type).forEach(other=>{ if(other!==e.target) other.checked=false; });
        renderTaken();
      });
    });
  });

  document.getElementById('filterStatusOk').checked=currentFilters.verbergOk;
  document.getElementById('filterGemarkeerd').checked=currentFilters.alleenGemarkeerd;

  document.getElementById('filterStatusOk').addEventListener('change', e=>{
    currentFilters.verbergOk=e.target.checked;
    renderTaken();
  });
  document.getElementById('filterGemarkeerd').addEventListener('change', e=>{
    currentFilters.alleenGemarkeerd=e.target.checked;
    renderTaken();
  });
}

function renderTaken(){
  const container=document.getElementById('tasks-container');
  container.innerHTML='';

  const today=new Date();
  const filtered=takenData.filter(t=>{
    if(currentFilters.verantwoordelijke && t.verantwoordelijke!==currentFilters.verantwoordelijke) return false;
    if(currentFilters.commissie && t.commissie!==currentFilters.commissie) return false;
    if(currentFilters.prioriteit && String(t.prioriteit)!==currentFilters.prioriteit) return false;
    if(currentFilters.verbergOk && t.status==='OK') return false;
    if(currentFilters.alleenGemarkeerd && !t.markeren) return false;
    return true;
  });

  filtered.forEach(t=>{
    const card=document.createElement('div');
    card.className='col s12';

    let cardClass='';
    if(t.status==='OK') cardClass='green lighten-4';
    else if(t.deadlineObj && today>=t.deadlineObj) cardClass='red lighten-4';
    if(t.markeren) card.classList.add('card-markeren');

    card.innerHTML=`
      <div class="card ${cardClass}">
        <div class="card-content">
          <span class="card-title">${t.taakomschrijving}</span>
          <p><strong>Deadline:</strong> ${t.deadlineFormatted || '-'}<br>
          <span style="font-weight:bold;">${t.deadlineObj?getDeadlineText(t.deadlineObj):''}</span></p>

          <p>
            <label><input type="checkbox" class="updateCheckbox" data-taakid="${t.taakId}" data-veld="markeren" ${t.markeren?'checked':''}/> <span>Markeren</span></label>
          </p>

          <p><strong>Prioriteit:</strong></p>
          <div id="cardPrioriteit_${t.taakId}"></div>

          <p><strong>Status:</strong></p>
          <div id="cardStatus_${t.taakId}"></div>

          <p><strong>Verantwoordelijke:</strong> <input type="text" class="updateInput" data-taakid="${t.taakId}" data-veld="verantwoordelijke" value="${t.verantwoordelijke || ''}"></p>

          <p>
            <label><input type="checkbox" class="updateCheckbox" data-taakid="${t.taakId}" data-veld="verouderd" ${t.verouderd?'checked':''}/> <span>Verouderd</span></label>
          </p>

          <p><strong>Commissie:</strong> ${t.commissie || '-'}</p>
          <p><strong>Bijlage:</strong> ${t.bijlage.includes('http')?`<a href="${t.bijlage}" target="_blank">Bekijk bijlage</a>`:t.bijlage || 'Geen bijlage voor deze taak.'}</p>
          <p class="taak-id"><strong>Taak ID:</strong> ${t.taakId}</p>
        </div>
      </div>
    `;

    container.appendChild(card);

    // Voeg checkboxen card Prioriteit toe
    const priorContainer=document.getElementById(`cardPrioriteit_${t.taakId}`);
    for(let i=1;i<=5;i++){
      const p=document.createElement('p');
      p.innerHTML=`<label><input type="checkbox" name="cardPrio_${t.taakId}" value="${i}" ${t.prioriteit==i?'checked':''}/> <span>${i}</span></label>`;
      priorContainer.appendChild(p);
    }
    document.getElementsByName(`cardPrio_${t.taakId}`).forEach(cb=>{
      cb.addEventListener('change', e=>{
        if(e.target.checked) currentCardChoices[`prio_${t.taakId}`]=e.target.value;
        else currentCardChoices[`prio_${t.taakId}`]='';
        document.getElementsByName(`cardPrio_${t.taakId}`).forEach(other=>{ if(other!==e.target) other.checked=false; });
        updateVeld(t.taakId,'prioriteit',currentCardChoices[`prio_${t.taakId}`]);
        fetchTaken(); // update kaart
      });
    });

    // Voeg checkboxen card Status toe
    const statusContainer=document.getElementById(`cardStatus_${t.taakId}`);
    ['NOK','Bezig','OK'].forEach(s=>{
      const p=document.createElement('p');
      p.innerHTML=`<label><input type="checkbox" name="cardStatus_${t.taakId}" value="${s}" ${t.status===s?'checked':''}/> <span>${s}</span></label>`;
      statusContainer.appendChild(p);
    });
    document.getElementsByName(`cardStatus_${t.taakId}`).forEach(cb=>{
      cb.addEventListener('change', e=>{
        if(e.target.checked) currentCardChoices[`status_${t.taakId}`]=e.target.value;
        else currentCardChoices[`status_${t.taakId}`]='';
        document.getElementsByName(`cardStatus_${t.taakId}`).forEach(other=>{ if(other!==e.target) other.checked=false; });
        updateVeld(t.taakId,'status',currentCardChoices[`status_${t.taakId}`]);
        fetchTaken(); // update kaart
      });
    });

  });
}

function updateVeld(taakId, veld, waarde){
  fetch(apiUrl,{
    method:'POST',
    body: JSON.stringify({spreadsheetId, tabblad, taakId, veld, waarde})
  })
  .then(res=>res.json())
  .then(res=>{if(res.status!=='ok') console.error(res.message);})
  .catch(err=>console.error(err));
}

fetchTaken();
setInterval(fetchTaken,15000);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
