<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taken Versie 20 - Chiro Leopoldsburg</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body { background-color: #f9fafb; }
nav { background-color: #c62828; }
.container { margin-top: 30px; }
.card { margin-bottom: 20px; position: relative; border-left: 5px solid transparent; }
.card-content { padding-bottom: 1rem; }
.filter-container { margin-bottom: 20px; }

/* Status tekstkleuren */
.status-ok { color: green; font-weight: bold; }
.status-bezig { color: orange; font-weight: bold; }
.status-nok { color: red; font-weight: bold; }

/* Prioriteit kleuren */
.prioriteit-1 { background-color: #ffffff; }
.prioriteit-2 { background-color: #ffcdd2; }
.prioriteit-3 { background-color: #ef9a9a; }
.prioriteit-4 { background-color: #e57373; }
.prioriteit-5 { background-color: #d32f2f; color: white; }
.prioriteit-label { padding: 3px 6px; border-radius: 4px; display: inline-block; }

/* Gemarkeerd */
.card-markeren { border-left: 5px solid orange; }

/* Taak ID onderaan */
.taak-id { font-size: 0.8rem; color: #555; margin-top: 10px; text-align: right; }
</style>
</head>
<body>

<nav>
  <div class="nav-wrapper">
    <a href="index.html" class="brand-logo center">Chiro Leopoldsburg</a>
  </div>
</nav>

<div class="container">
<h4 class="center-align">Taken Versie 20</h4>

<div class="filter-container row">
  <div class="input-field col s12 m2">
    <select id="filterVerantwoordelijke"><option value="" selected>Alle verantwoordelijken</option></select>
    <label>Verantwoordelijke</label>
  </div>
  <div class="input-field col s12 m2">
    <select id="filterCommissie"><option value="" selected>Alle commissies</option></select>
    <label>Commissie</label>
  </div>
  <div class="input-field col s12 m2">
    <select id="filterPrioriteit"><option value="" selected>Alle prioriteiten</option></select>
    <label>Prioriteit</label>
  </div>
  <div class="col s12 m2">
    <p>
      <label>
        <input type="checkbox" id="filterStatusOk">
        <span>Verberg taken met status "OK"</span>
      </label>
    </p>
    <p>
      <label>
        <input type="checkbox" id="filterGemarkeerd">
        <span>Toon alleen gemarkeerde taken</span>
      </label>
    </p>
  </div>
</div>

<div id="tasks-container" class="row"></div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const spreadsheetId = urlParams.get('spreadsheetId');
const tabblad = urlParams.get('tabblad');

const apiUrl = 'https://script.google.com/macros/s/AKfycbzxE1xtIxwT74WNMdfqYhhG4UGC8g2pUumgI2hK3CjW5RcVa3n5Q1UXNW64nHTHc6smig/exec';

let takenData = [];
const statusOptions = ["NOK", "Bezig", "OK"];

function getDeadlineText(deadlineObj) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const deadline = new Date(deadlineObj);
  deadline.setHours(0,0,0,0);

  const diffTime = deadline - today;
  const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

  if(diffDays < 0) {
    return `Deadline is met ${Math.abs(diffDays)} dagen overschreden`;
  } else if(diffDays === 0) {
    return `Deadline is vandaag!`;
  } else {
    return `Deadline is over ${diffDays} dagen`;
  }
}

async function fetchTaken() {
  try {
    const response = await fetch(`${apiUrl}?spreadsheetId=${spreadsheetId}&tabblad=${tabblad}`);
    const data = await response.json();

    data.forEach(t => {
      if(t.deadline) {
        const d = new Date(t.deadline);
        t.deadlineFormatted = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
        t.deadlineObj = d;
      }
    });

    takenData = data;
    vulFilters();
    renderTaken();
  } catch(err) {
    console.error("Fout bij ophalen taken:", err);
  }
}

function vulFilters() {
  const verantwoordelijken = [...new Set(takenData.map(t => t.verantwoordelijke).filter(Boolean))];
  const commissies = [...new Set(takenData.map(t => t.commissie).filter(Boolean))];
  const prioriteiten = [...new Set(takenData.map(t => t.prioriteit).filter(Boolean))].sort((a,b)=>a-b);

  const selectVer = document.getElementById('filterVerantwoordelijke');
  selectVer.innerHTML = '<option value="" selected>Alle verantwoordelijken</option>';
  verantwoordelijken.forEach(v => { const option = document.createElement('option'); option.value=v; option.textContent=v; selectVer.appendChild(option); });

  const selectCom = document.getElementById('filterCommissie');
  selectCom.innerHTML = '<option value="" selected>Alle commissies</option>';
  commissies.forEach(c => { const option = document.createElement('option'); option.value=c; option.textContent=c; selectCom.appendChild(option); });

  const selectPrio = document.getElementById('filterPrioriteit');
  selectPrio.innerHTML = '<option value="" selected>Alle prioriteiten</option>';
  prioriteiten.forEach(p => { const option = document.createElement('option'); option.value=p; option.textContent=p; selectPrio.appendChild(option); });

  M.FormSelect.init(selectVer);
  M.FormSelect.init(selectCom);
  M.FormSelect.init(selectPrio);

  selectVer.addEventListener('change', renderTaken);
  selectCom.addEventListener('change', renderTaken);
  selectPrio.addEventListener('change', renderTaken);
  document.getElementById('filterStatusOk').addEventListener('change', renderTaken);
  document.getElementById('filterGemarkeerd').addEventListener('change', renderTaken);
}

function renderTaken() {
  const container = document.getElementById('tasks-container');

  const selectedVer = document.getElementById('filterVerantwoordelijke').value;
  const selectedCom = document.getElementById('filterCommissie').value;
  const selectedPrio = document.getElementById('filterPrioriteit').value;
  const verbergOk = document.getElementById('filterStatusOk').checked;
  const alleenGemarkeerd = document.getElementById('filterGemarkeerd').checked;

  const today = new Date();

  takenData.forEach(t => {
    const cardId = `taak-${t.taakId}`;
    let card = document.getElementById(cardId);

    const shouldShow = 
      (!selectedVer || t.verantwoordelijke===selectedVer) &&
      (!selectedCom || t.commissie===selectedCom) &&
      (!selectedPrio || t.prioriteit==selectedPrio) &&
      (!verbergOk || t.status!=='OK') &&
      (!alleenGemarkeerd || t.markeren);

    if(!card && shouldShow){
      card = document.createElement('div');
      card.className='col s12';
      card.id = cardId;
      container.appendChild(card);
    } else if(card && !shouldShow) {
      card.remove();
      return;
    }

    const cardClassList = [];
    if(t.status==='OK') cardClassList.push('green','lighten-4');
    else if(t.deadlineObj && today >= t.deadlineObj) cardClassList.push('red','lighten-4');

    card.innerHTML = `
      <div class="card ${cardClassList.join(' ')} ${t.markeren?'card-markeren':''}">
        <div class="card-content">
          <span class="card-title">${t.taakomschrijving}</span>
          <p><strong>Deadline:</strong> ${t.deadlineFormatted || '-'}<br>
          <span style="font-weight:bold;">${t.deadlineObj ? getDeadlineText(t.deadlineObj) : ''}</span></p>

          <p>
            <label>
              <input type="checkbox" class="updateCheckbox" data-taakid="${t.taakId}" data-veld="markeren" ${t.markeren ? 'checked' : ''}/>
              <span>Markeren</span>
            </label>
          </p>

          <p>
            <strong>Prioriteit:</strong>
            <select class="updateSelect prioriteit-select" data-taakid="${t.taakId}" data-veld="prioriteit">
              <option value="1" ${t.prioriteit=="1"?"selected":""}>1</option>
              <option value="2" ${t.prioriteit=="2"?"selected":""}>2</option>
              <option value="3" ${t.prioriteit=="3"?"selected":""}>3</option>
              <option value="4" ${t.prioriteit=="4"?"selected":""}>4</option>
              <option value="5" ${t.prioriteit=="5"?"selected":""}>5</option>
            </select>
          </p>

          <p>
            <strong>Verantwoordelijke:</strong>
            <input type="text" class="updateInput" data-taakid="${t.taakId}" data-veld="verantwoordelijke" value="${t.verantwoordelijke || ''}">
          </p>

          <p>
            <strong>Status:</strong>
            <select class="updateSelect status-select" data-taakid="${t.taakId}" data-veld="status">
              ${statusOptions.map(opt => `<option value="${opt}" ${t.status===opt?"selected":""}>${opt}</option>`).join('')}
            </select>
          </p>

          <p>
            <label>
              <input type="checkbox" class="updateCheckbox" data-taakid="${t.taakId}" data-veld="verouderd" ${t.verouderd ? 'checked' : ''}/>
              <span>Verouderd</span>
            </label>
          </p>

          <p><strong>Commissie:</strong> ${t.commissie || '-'}</p>
          <p><strong>Bijlage:</strong> ${t.bijlage.includes('http') ? `<a href="${t.bijlage}" target="_blank">Bekijk bijlage</a>` : t.bijlage || 'Geen bijlage voor deze taak.'}</p>
          <p class="taak-id"><strong>Taak ID:</strong> ${t.taakId}</p>
        </div>
      </div>
    `;

    // Materialize init voor select
    const selects = card.querySelectorAll('select');
    selects.forEach(sel => {
      const instance = M.FormSelect.getInstance(sel);
      if(instance) instance.destroy();
      M.FormSelect.init(sel);
    });

    // Checkbox event
    card.querySelectorAll('.updateCheckbox').forEach(cb=>{
      cb.addEventListener('change', e=>{
        updateVeld(e.target.dataset.taakid, e.target.dataset.veld, e.target.checked);
      });
    });

    // Select event
    card.querySelectorAll('.updateSelect').forEach(sel=>{
      sel.addEventListener('change', e=>{
        updateVeld(e.target.dataset.taakid, e.target.dataset.veld, e.target.value);
        // Direct kleuren aanpassen
        const cardDiv = sel.closest('.card');
        if(sel.dataset.veld==='status'){
          cardDiv.classList.remove('green','red','orange','lighten-4');
          sel.classList.remove('green-text','orange-text','red-text','text-darken-3','text-darken-4');
          if(e.target.value==='OK'){
            cardDiv.classList.add('green','lighten-4'); sel.classList.add('green-text','text-darken-4');
          } else if(e.target.value==='Bezig'){
            cardDiv.classList.add('orange','lighten-4'); sel.classList.add('orange-text','text-darken-3');
          } else if(e.target.value==='NOK'){
            cardDiv.classList.add('red','lighten-4'); sel.classList.add('red-text','text-darken-3');
          }
        }
        if(sel.dataset.veld==='prioriteit'){
          sel.className = `updateSelect prioriteit-select prioriteit-${e.target.value}`;
        }
      });
    });

    // Input event
    card.querySelectorAll('.updateInput').forEach(inp=>{
      inp.addEventListener('change', e=>{
        updateVeld(e.target.dataset.taakid, e.target.dataset.veld, e.target.value);
      });
    });
  });
}

function updateVeld(taakId, veld, waarde){
  fetch(apiUrl,{
    method:'POST',
    body: JSON.stringify({ spreadsheetId, tabblad, taakId, veld, waarde })
  }).then(res=>res.json())
  .then(res=>{ if(res.status!=='ok') console.error(res.message); })
  .catch(err=>console.error(err));
}

// Initial fetch + interval
fetchTaken();
setInterval(()=>fetchTaken(), 5000);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
