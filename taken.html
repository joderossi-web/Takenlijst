<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Taken</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
</head>
<body>
  <div class="container">
    <h3>Taken</h3>
    <div id="taken-container" class="row"></div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw7vdNL-mtGsR8pthDwJI_s_6ItncNNOts4PDJ1gYxdSTiiVPmp3kAKKifEtjfDzWgDNQ/exec
";

function getQueryParam(param){
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

const sheetId = getQueryParam("sheetId");
const tabName = getQueryParam("tab");

// Bidirectionele update
async function updateTask(taskId, changes){
  changes.ID = taskId;
  changes.sheetId = sheetId;
  changes.tab = tabName;

  await fetch(API_URL, {method:"POST", body:JSON.stringify(changes)});
}

// Fetch en render taken
async function fetchTaken(){
  try {
    const res = await fetch(`${API_URL}?sheetId=${sheetId}&tab=${tabName}`);
    const data = await res.json();
    const container = document.getElementById("taken-container");
    container.innerHTML = "";

    data.taken.forEach(task=>{
      const card = document.createElement("div");
      card.className = "col s12";
      card.innerHTML = `
        <div class="card grey lighten-4">
          <div class="card-content">
            <span class="card-title">${task["Taak"]}</span>
            <p>Deadline: <input type="date" value="${task["Deadline"]}" id="date-${task["ID"]}"></p>
            <p>Prioriteit:
              <select id="prio-${task["ID"]}">
                <option value="1" ${task["Prioriteit"]==1?"selected":""}>1</option>
                <option value="2" ${task["Prioriteit"]==2?"selected":""}>2</option>
                <option value="3" ${task["Prioriteit"]==3?"selected":""}>3</option>
                <option value="4" ${task["Prioriteit"]==4?"selected":""}>4</option>
                <option value="5" ${task["Prioriteit"]==5?"selected":""}>5</option>
              </select>
            </p>
            <p>Belangrijk: <input type="checkbox" id="check-${task["ID"]}" ${task["Belangrijk"]?"checked":""}></p>
          </div>
        </div>
      `;
      container.appendChild(card);

      document.getElementById(`date-${task["ID"]}`).addEventListener("change", e=>updateTask(task["ID"], {"Deadline": e.target.value}));
      document.getElementById(`prio-${task["ID"]}`).addEventListener("change", e=>updateTask(task["ID"], {"Prioriteit": e.target.value}));
      document.getElementById(`check-${task["ID"]}`).addEventListener("change", e=>updateTask(task["ID"], {"Belangrijk": e.target.checked}));
    });
  } catch(err){
    console.error(err);
    document.getElementById("taken-container").innerHTML = "<p>Fout bij laden taken.</p>";
  }
}

document.addEventListener("DOMContentLoaded", fetchTaken);
</script>
</body>
</html>
