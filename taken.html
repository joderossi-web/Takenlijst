<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taken Versie 09 - Chiro Leopoldsburg</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body { background-color: #f9fafb; }
    nav { background-color: #c62828; }
    .container { margin-top: 30px; }
    .card { margin-bottom: 20px; }
    .card.red { border-left: 5px solid red; }
    .filter-container { margin-bottom: 20px; }
    #update-notice { display: none; margin-bottom: 20px; padding: 10px; background-color: #ffeb3b; font-weight: bold; text-align: center; }

    /* Statuskleuren */
    .status-nok { color: red; font-weight: bold; }
    .status-bezig { color: orange; font-weight: bold; }
    .status-ok { color: green; font-weight: bold; }
  </style>
</head>
<body>

  <nav>
    <div class="nav-wrapper">
      <a href="index.html" class="brand-logo center">Chiro Leopoldsburg</a>
    </div>
  </nav>

  <div class="container">
    <h4 class="center-align">Taken Versie 09</h4>

    <!-- Update notice -->
    <div id="update-notice">
      Er zijn nieuwe updates, klik op <button id="refreshBtn" class="btn red">Vernieuw taken</button>
    </div>

    <div class="filter-container row">
      <div class="input-field col s12 m4">
        <select id="filterVerantwoordelijke"><option value="" selected>Alle verantwoordelijken</option></select>
        <label>Verantwoordelijke</label>
      </div>
      <div class="input-field col s12 m4">
        <select id="filterCommissie"><option value="" selected>Alle commissies</option></select>
        <label>Commissie</label>
      </div>
      <div class="input-field col s12 m4">
        <label>
          <input type="checkbox" id="filterStatusOk">
          <span>Verberg taken met status "OK"</span>
        </label>
      </div>
    </div>

    <div id="tasks-container" class="row"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const spreadsheetId = urlParams.get('spreadsheetId');
    const tabblad = urlParams.get('tabblad');

    const apiUrl = 'https://script.google.com/macros/s/AKfycbzxE1xtIxwT74WNMdfqYhhG4UGC8g2pUumgI2hK3CjW5RcVa3n5Q1UXNW64nHTHc6smig/exec';

    let takenData = [];
    let lastFetchedData = '';
    const statusOptions = ["NOK", "Bezig", "OK"];

    async function fetchTaken(showNoticeIfChanged = false) {
      try {
        const response = await fetch(`${apiUrl}?spreadsheetId=${spreadsheetId}&tabblad=${tabblad}`);
        const data = await response.json();

        // Format datum
        data.forEach(t => {
          if(t.deadline) {
            const d = new Date(t.deadline);
            t.deadline = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
          }
        });

        // Controleer of er iets veranderd is
        const dataString = JSON.stringify(data);
        if(showNoticeIfChanged && dataString !== lastFetchedData) {
          document.getElementById('update-notice').style.display = 'block';
        }
        lastFetchedData = dataString;

        takenData = data;
        vulFilters();
        renderTaken();
      } catch(err) {
        console.error("Fout bij ophalen taken:", err);
      }
    }

    function vulFilters() {
      const verantwoordelijken = [...new Set(takenData.map(t => t.verantwoordelijke).filter(Boolean))];
      const commissies = [...new Set(takenData.map(t => t.commissie).filter(Boolean))];

      const selectVer = document.getElementById('filterVerantwoordelijke');
      selectVer.innerHTML = '<option value="" selected>Alle verantwoordelijken</option>';
      verantwoordelijken.forEach(v => {
        const option = document.createElement('option');
        option.value = v;
        option.textContent = v;
        selectVer.appendChild(option);
      });

      const selectCom = document.getElementById('filterCommissie');
      selectCom.innerHTML = '<option value="" selected>Alle commissies</option>';
      commissies.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        selectCom.appendChild(option);
      });

      M.FormSelect.init(selectVer);
      M.FormSelect.init(selectCom);

      selectVer.addEventListener('change', renderTaken);
      selectCom.addEventListener('change', renderTaken);
      document.getElementById('filterStatusOk').addEventListener('change', renderTaken);
    }

    function renderTaken() {
      const container = document.getElementById('tasks-container');
      container.innerHTML = '';

      const selectedVer = document.getElementById('filterVerantwoordelijke').value;
      const selectedCom = document.getElementById('filterCommissie').value;
      const verbergOk = document.getElementById('filterStatusOk').checked;

      const filtered = takenData.filter(t => {
        if(selectedVer && t.verantwoordelijke !== selectedVer) return false;
        if(selectedCom && t.commissie !== selectedCom) return false;
        if(verbergOk && t.status === 'OK') return false;
        return true;
      });

      filtered.forEach(t => {
        const card = document.createElement('div');
        card.className = 'col s12';
        const statusClass = t.status?.toLowerCase().replace(/\s/g,'') || '';
        card.innerHTML = `
          <div class="card ${t.markeren ? 'red' : ''}">
            <div class="card-content">
              <span class="card-title">${t.taakomschrijving}</span>
              <p><strong>Taak ID:</strong> ${t.taakId}</p>
              <p><strong>Deadline:</strong> ${t.deadline || '-'}</p>

              <p>
                <label>
                  <input type="checkbox" class="updateCheckbox" data-taakid="${t.taakId}" data-veld="markeren" ${t.markeren ? 'checked' : ''}/>
                  <span>Markeren</span>
                </label>
              </p>

              <p>
                <strong>Prioriteit:</strong>
                <select class="updateSelect" data-taakid="${t.taakId}" data-veld="prioriteit">
                  <option value="1" ${t.prioriteit=="1"?"selected":""}>1</option>
                  <option value="2" ${t.prioriteit=="2"?"selected":""}>2</option>
                  <option value="3" ${t.prioriteit=="3"?"selected":""}>3</option>
                  <option value="4" ${t.prioriteit=="4"?"selected":""}>4</option>
                  <option value="5" ${t.prioriteit=="5"?"selected":""}>5</option>
                </select>
              </p>

              <p>
                <strong>Verantwoordelijke:</strong>
                <input type="text" class="updateInput" data-taakid="${t.taakId}" data-veld="verantwoordelijke" value="${t.verantwoordelijke || ''}">
              </p>

              <p>
                <strong>Status:</strong>
                <select class="updateSelect status-select ${statusClass}" data-taakid="${t.taakId}" data-veld="status">
                  ${statusOptions.map(opt => `<option value="${opt}" ${t.status===opt?"selected":""}>${opt}</option>`).join('')}
                </select>
              </p>

              <p>
                <label>
                  <input type="checkbox" class="updateCheckbox" data-taakid="${t.taakId}" data-veld="verouderd" ${t.verouderd ? 'checked' : ''}/>
                  <span>Verouderd</span>
                </label>
              </p>

              <p><strong>Commissie:</strong> ${t.commissie || '-'}</p>
              <p><strong>Bijlage:</strong> ${t.bijlage.includes('http') 
                ? `<a href="${t.bijlage}" target="_blank">Bekijk bijlage</a>` 
                : t.bijlage || 'Geen bijlage voor deze taak.'}</p>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      // Materialize select init na DOM update
      document.querySelectorAll('select.updateSelect').forEach(sel => {
        const instance = M.FormSelect.getInstance(sel);
        if(instance) instance.destroy();
        M.FormSelect.init(sel);
      });

      // Checkbox event listeners
      document.querySelectorAll('.updateCheckbox').forEach(cb => {
        cb.addEventListener('change', e => {
          updateVeld(e.target.dataset.taakid, e.target.dataset.veld, e.target.checked);
          if(e.target.dataset.veld === 'markeren') {
            const card = e.target.closest('.card');
            if(e.target.checked) card.classList.add('red');
            else card.classList.remove('red');
          }
        });
      });

      // Select event listeners
      document.querySelectorAll('.updateSelect').forEach(sel => {
        sel.addEventListener('change', e => {
          updateVeld(e.target.dataset.taakid, e.target.dataset.veld, e.target.value);
        });
      });

      // Input event listeners
      document.querySelectorAll('.updateInput').forEach(inp => {
        inp.addEventListener('change', e => {
          updateVeld(e.target.dataset.taakid, e.target.dataset.veld, e.target.value);
        });
      });
    }

    function updateVeld(taakId, veld, waarde) {
      fetch(apiUrl, {
        method: 'POST',
        body: JSON.stringify({ spreadsheetId, tabblad, taakId, veld, waarde })
      })
      .then(res => res.json())
      .then(res => { if(res.status !== 'ok') console.error(res.message); })
      .catch(err => console.error(err));
    }

    // Event listener voor refresh knop
    document.getElementById('refreshBtn').addEventListener('click', () => {
      fetchTaken(false);
      document.getElementById('update-notice').style.display = 'none';
    });

    // Start de app
    fetchTaken();

    // Polling elke 15 seconden
    setInterval(() => fetchTaken(true), 15000);

  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
